<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>JIvE library</title>
	<script src="canvas.js"></script>
	<script src="imageLoader.js"></script>
	<script src="Box2dWeb-2.1.a.3.min.js"></script>
	<script src="eventEmitter.js"></script>
	<script src="physicsEngine.js"></script>
	<script src="tiledMap.js"></script>
	<script src="camera.js"></script>
	<script src="renderer.js"></script>
	<script src="selector.js"></script>
	<script src="inputHandler.js"></script>
	<script src="jive.js"></script>
	<script src="tiledMapRenderer.js"></script>
	<script src="entityRenderer.js"></script>
	<script src="utils.js"></script>
	<script src="entity.js"></script>
	<script src="unit.js"></script>
	<script src="shapes.js"></script>
	<script src="selectorRenderer.js"></script>
	<script src="entities.js"></script>


	<style>

		html {
			height: 100%;
			overflow: hidden
		}

		body {
			margin: 0px;
			padding: 0px;
			height: 100%;
			overflow: hidden;
			font-family: 'Proxima Nova Regular', 'Helvetica Neue', Arial, Helvetica, sans-serif;
			font-size: 12px;
		}

		canvas {
			border: 1px solid #d3d3d3;
			background-color: #f1f1f1;
		}

	</style>
</head>

<body>
	


	<script>	

	url = "https://raw.githubusercontent.com/skaparelos/random-tests/master/map.json"
	var map, renderer, camera, ih, selector;


	//todo remove:
	var mouseJoint = null;
	var mouseX, mouseY;

	function init(){
		renderer = JIVE.Renderer;
		camera = JIVE.Camera;

		// register bindings
		ih = JIVE.InputHandler;
		ih.bind(JIVE.Keys.ARROW_UP, 'move-up');
		ih.bind(JIVE.Keys.W, 'move-up');
		ih.bind(JIVE.Keys.ARROW_DOWN, 'move-down');
		ih.bind(JIVE.Keys.S, 'move-down');
		ih.bind(JIVE.Keys.ARROW_LEFT, 'move-left');
		ih.bind(JIVE.Keys.A, 'move-left');
		ih.bind(JIVE.Keys.ARROW_RIGHT, 'move-right');
		ih.bind(JIVE.Keys.D, 'move-right');
		ih.bind(JIVE.Mouse.LEFT, 'click-left');
		ih.bind(JIVE.Mouse.RIGHT, 'click-right');

		selector = JIVE.Selector;

		// you can do something like this, but it is veeery slow
		camera.on('move-up', function(){
			//camera.move({up:1, right:0, left:0, down:0}, dt)

			// TODO problem with dt. we need to be able to access dt
			// when calling the camera.
		});


		ih.on('click-left', function(e) {
			console.log(Utils.screen2MapCoords(e, camera));

			/* todo
            var body = JIVE.PhysicsEngine.getBodyAtMouse(e);
            if(body) {
                var md = new JIVE.PhysicsEngine.b2MouseJointDef();
                md.bodyA = JIVE.PhysicsEngine.world.GetGroundBody();
                md.bodyB = body;
                mouseX = e.clientX/30;
                mouseY = e.clientY/30;
                md.target.Set(mouseX, mouseY);
                md.collideConnected = true;
                md.maxForce = 100.0 * body.GetMass();
                mouseJoint = JIVE.PhysicsEngine.world.CreateJoint(md);
                body.SetAwake(true);
            }
            */

			//Entities[0].move(1, 0, map);
			//console.log(JIVE.Entities[0].move(3, 0, camera).mapX);
		});

		ih.on('click-right', function(e){
			console.log("right click");
		});

		map = JIVE.Map;
		map.loadJSON(url, camera, function(){
			if(map.isLoaded())
				JIVE.reqAnimFrame(animate);
		});
	}

	function animate(dt){

		var direction = {
		    up: ih.getActionState("move-up"),
			right: ih.getActionState('move-right'),
			left: ih.getActionState('move-left'),
			down: ih.getActionState('move-down')
		};

		var dxdy = camera.move(direction, dt);

		// get the selected area (if any)
		var rect = selector.getSelectedRect();

		// update Entities and physics engine
		JIVE.Entities.forEach(function(entity){
			entity.update(dxdy, dt, rect);
		});
		JIVE.PhysicsEngine.update();


		if (JIVE.settings.DEBUG) {
            if (Math.random() > 0.5)
                renderer.draw(camera, map, JIVE.Entities, selector);
            else
                JIVE.PhysicsEngine.draw();
        }else{
            renderer.draw(camera, map, JIVE.Entities, selector);
		}
		/*
        //TODO remove
        if(mouseJoint) {
            if(ih.getActionState('mousedown')) {
                mouseJoint.SetTarget(new JIVE.PhysicsEngine.b2Vec2(mouseX, mouseY));
            } else {
                JIVE.PhysicsEngine.world.DestroyJoint(mouseJoint);
                mouseJoint = null;
            }
        }
		*/

	}


	</script>

</body>